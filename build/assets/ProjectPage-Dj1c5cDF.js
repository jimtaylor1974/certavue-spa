import{r as f,j as e,y as Ze,I as w,G as xe,A as be,B as A,b as K,z as ne,c as V,d as _,h as H,E as oe,k as Se,u as Ne,bQ as Le,bR as Ye,R as We,q as Ee,x as Ie,X as De,S as Pe,l as Qe,H as we,ba as Ae,U as Oe,v as Ke}from"./index-kwN8UPoG.js";import{B as _e,a as He}from"./BreadcrumbItem-BWNVhrZr.js";import{f as Q,u as Je,e as je}from"./dateUtils-BzoKknhP.js";import{R as Y,C as P}from"./Col-3tbZRZzl.js";import{T as Ve}from"./Table-DqmGEuFS.js";import{F as O,L as F}from"./Label-DetdrR8a.js";import{F as ue}from"./FormText-Cbl6G9WZ.js";import{P as Te}from"./PersonSelector-C4MYiwNh.js";import{c as ge,b as te,T as Xe}from"./TagSelector-CeupwwDV.js";import{T as Be,S as es}from"./TimeZoneSelect-rgichJ6B.js";import{g as U,a as z,b as ss}from"./scheduling-Dt-i_BnX.js";import{M as Fe,a as Ue,b as Re,c as ze}from"./ModalFooter-BGjWCMUk.js";import{P as $,E as G,a as se,b as me,c as he}from"./types-46npvi_j.js";import{u as ts,C as ke,D as ve}from"./DisplayFormError-CdXJf4Rd.js";import{u as ns}from"./useConfirm-CAR54Gpn.js";import{u as is,D as rs,d as Ce,G as as,M as os,e as ls}from"./tags-Bt08gbtc.js";import{S as $e}from"./save-CV-md-Yi.js";import{P as Me}from"./plus-BWkvl-WH.js";import{T as ye}from"./trash-2-DgPkiiio.js";import{u as ds}from"./useGetPagedTeams-B8jcmSRS.js";import{C as fe}from"./refresh-cw-CH8H1w-5.js";import{E as cs}from"./eye-hwjvCcnd.js";import{C as ms}from"./clock-DtOKZevz.js";import"./ListGroupItem-DctkbJNp.js";import"./useGetPagedPersons-aQDNOo1Y.js";import"./Pagination-62Q_1YwI.js";import"./ButtonGroup-BPzFq4yX.js";import"./CardBody-DxL1EV3t.js";import"./search-Mcy6RLxT.js";import"./chevron-left-DjnC65PD.js";import"./Search-BgZkiD_X.js";import"./InputGroupText-BRavtHVL.js";import"./user-plus-DuuDWjAf.js";import"./v4-C6aID195.js";import"./createClass-B87_d8m-.js";import"./floating-ui.dom-B64eMHnB.js";import"./arrow-left-WLfKCuJw.js";import"./trending-up-3PWcSvGs.js";import"./folder-BR4_c-Z9.js";import"./triangle-alert-BY25SqKN.js";import"./chevron-up-nRn8ESxu.js";import"./circle-plus-DKWOylAy.js";import"./ellipsis-vertical-GJy7xNcY.js";import"./eye-off-BfhUdxR6.js";import"./file-pen-D9SZuFgP.js";import"./folder-up-CBVdd0PI.js";import"./log-in-mbRRY23A.js";import"./mouse-pointer-click-XjeC9koc.js";import"./play-BXBwsEkZ.js";import"./share-2-g7_b6gTz.js";const Ge=({value:s,onChange:a,label:o="Week",className:r="",disabled:i=!1})=>{const c=f.useCallback(p=>{try{return p&&p>0?U(z(p)):U(new Date)}catch{return U(z(1))}},[]),j=f.useMemo(()=>c(s),[s,c]),k=f.useMemo(()=>ge(j.mondayOfWeek),[j]),v=f.useCallback(p=>{if(p<2025)return[];const N=[];try{let x=ss(new Date(p,0,4));ge(x)<p&&(x=te(x,7));for(let b=0;b<54;b++){const R=ge(x);if(R===p)N.push(U(x));else if(R>p)break;x=te(x,7)}}catch(x){console.error(`Error generating weeks for year ${p}:`,x)}return N},[]),h=f.useMemo(()=>v(k),[k,v]),W=p=>{const N=parseInt(p.target.value,10);if(!isNaN(N)&&N>=2025){const x=v(N);if(x.length>0){const b=x[0];a(b.globalWeekNumber,b)}}},E=p=>{const N=parseInt(p.target.value,10);if(!isNaN(N)){const x=c(N);a(N,x)}};return e.jsxs(O,{className:r,children:[o&&e.jsx(F,{for:"week-selector-year",className:"mb-1",children:o}),e.jsxs(Ze,{size:"sm",children:[e.jsx(w,{id:"week-selector-year",type:"number",value:k,onChange:W,disabled:i,min:"2025",style:{flex:"0 0 90px"},"aria-label":"Year"}),e.jsx(w,{id:"week-selector-week",type:"select",value:s||"",onChange:E,disabled:i||h.length===0,"aria-label":"Week",children:h.map(p=>e.jsx("option",{value:p.globalWeekNumber,children:`Week ${p.weekOfYear} (${Q(p.mondayOfWeek)})`},p.globalWeekNumber))})]}),j&&e.jsxs(ue,{children:["Mon, ",Q(j.mondayOfWeek)]})]})},ce=({isOpen:s,onClose:a,onSubmit:o,description:r,isPending:i=!1,projectStatus:c})=>{const[j,k]=f.useState(""),[v,h]=f.useState(null),W=c===$.Published,E=N=>{N.preventDefault(),h(null);const x=j.trim();if(W&&(!x||x.length<5||/^[.,]+$/.test(x))){h("Please provide a meaningful reason for this change");return}o(x),k(""),a()},p=()=>{k(""),h(null),a()};return e.jsx(Fe,{isOpen:s,toggle:p,children:e.jsxs(xe,{onSubmit:E,children:[e.jsx(Ue,{toggle:p,children:W?"Reason for Change Required":"Confirm Action"}),e.jsxs(Re,{children:[e.jsxs("p",{children:["You are about to: ",e.jsx("strong",{children:r})]}),e.jsx("p",{children:W?"Please provide a reason for this change:":"You may optionally provide a reason for this change:"}),v&&e.jsx(be,{color:"danger",children:v}),e.jsx(O,{children:e.jsx(w,{id:"changeReason",type:"textarea",value:j,onChange:N=>k(N.target.value),rows:3,disabled:i,required:W})})]}),e.jsxs(ze,{children:[e.jsx(A,{color:"secondary",onClick:p,disabled:i,children:"Cancel"}),e.jsx(A,{color:"primary",type:"submit",disabled:i,children:i?"Saving...":"Submit"})]})]})})},us=()=>{const s=K(),a=ne();return V({mutationFn:async o=>{const r=await s(`${_}/api/projects`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});return H(r)},onSuccess:()=>{a.invalidateQueries({queryKey:["projects"]})}})},hs=()=>{const s=K(),a=ne();return V({mutationFn:async o=>{const r=await s(`${_}/api/projects/${o.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});return H(r)},onSuccess:()=>{a.invalidateQueries({queryKey:["projects"]})}})},xs=()=>{const s=K(),a=ne();return V({mutationFn:async({projectId:o,newStatus:r,changeReason:i})=>{const c=await s(`${_}/api/projects/${o}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:r,changeReason:i})});return H(c)},onSuccess:()=>{a.invalidateQueries({queryKey:["projects"]})}})},gs=()=>{const s=K(),a=ne();return V({mutationFn:async({projectId:o,newVisibility:r,changeReason:i})=>{const c=await s(`${_}/api/projects/${o}/visibility`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({visibility:r,changeReason:i})});return H(c)},onSuccess:()=>{a.invalidateQueries({queryKey:["projects"]})}})},ps=()=>{const s=K(),a=ne();return V({mutationFn:async({projectId:o,timeZone:r,changeReason:i})=>{const c=await s(`${_}/api/projects/${o}/timezone`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({timeZone:r,changeReason:i})});return H(c)},onSuccess:(o,r)=>{a.invalidateQueries({queryKey:["projects"]}),a.invalidateQueries({queryKey:["projects",r.projectId]})}})},js=({isOpen:s,onClose:a,projectId:o,currentTimeZone:r,projectStatus:i,onSuccess:c})=>{const[j,k]=f.useState(null),{control:v,handleSubmit:h,reset:W}=ts({defaultValues:{timeZone:r,changeReason:""}}),E=ps(),p=async x=>{k(null),E.mutate({projectId:o,timeZone:x.timeZone,changeReason:x.changeReason},{onSuccess:()=>{W(),a(),c&&c()},onError:b=>{console.error("Error changing timezone:",b),k(b)}})},N=()=>{W(),k(null),a()};return e.jsxs(Fe,{isOpen:s,toggle:N,children:[e.jsx(Ue,{toggle:N,children:"Change Project Timezone"}),e.jsxs(xe,{onSubmit:h(p),children:[e.jsxs(Re,{children:[e.jsx(oe,{error:j}),e.jsx(O,{children:e.jsx(ke,{name:"timeZone",control:v,rules:{required:"Time zone is required"},render:({field:x,fieldState:b})=>e.jsxs(e.Fragment,{children:[e.jsx(Be,{value:x.value,onChange:x.onChange,className:"mb-3",label:"New Timezone"}),b.error&&e.jsx(ve,{error:b.error,fieldDisplayName:"Time Zone"})]})})}),e.jsx(O,{children:e.jsx(ke,{name:"changeReason",control:v,rules:{required:i!==$.Draft?"Change reason is required":!1},render:({field:x,fieldState:b})=>e.jsxs(e.Fragment,{children:[e.jsxs("label",{htmlFor:"changeReason",className:"form-label",children:["Reason for Change"," ",i!==$.Draft?"*":""]}),e.jsx("textarea",{...x,id:"changeReason",className:"form-control",rows:3,placeholder:i===$.Draft?"Optional: Provide a reason for changing the timezone...":"Please provide a reason for changing the timezone..."}),b.error&&e.jsx(ve,{error:b.error,fieldDisplayName:"Change Reason"})]})})})]}),e.jsxs(ze,{children:[e.jsx(A,{color:"secondary",onClick:N,children:"Cancel"}),e.jsx(A,{color:"primary",type:"submit",disabled:E.isPending,children:E.isPending?"Changing...":"Change Timezone"})]})]})]})},fs=({project:s,onSave:a,onCancel:o})=>{const r=Se(),{confirm:i,confirmModal:c}=ns(),{personId:j}=Ne(),[k,v]=f.useState(!1),[h,W]=f.useState(!1),[E,p]=f.useState(null),N=xs(),x=gs(),[b,R]=f.useState(null),{mondayOfWeek:M,globalWeekNumber:ie}=U(new Date),q=M.toISOString().split("T")[0],[y,T]=f.useState({name:"",description:"",timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone,startOn:q,durationInWeeks:1,engagementContext:G.BAU,people:[]}),[X,re]=f.useState(ie),[le,ee]=f.useState([]),[de,J]=f.useState(null),{isLoading:l}=is(!0);f.useEffect(()=>{if(s){T({name:s.name,description:s.description,timeZone:s.timeZone||Intl.DateTimeFormat().resolvedOptions().timeZone,startOn:s.startOn.split("T")[0],durationInWeeks:s.durationInWeeks,engagementContext:s.engagementContext||G.BAU,people:s.people.map(m=>({personId:m.personId,projectRole:m.projectRole,canEdit:m.canEdit,canEditResources:m.canEditResources}))}),ee(s.tags||[]);try{const m=U(new Date(s.startOn));re(m.globalWeekNumber)}catch(m){console.error("Error getting week info for project start date:",m)}}else T({name:"",description:"",timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone,startOn:q,durationInWeeks:1,engagementContext:G.BAU,people:[]}),ee([]),re(ie);J(null)},[s,ie,q]);const u=us(),t=hs(),d=f.useMemo(()=>{const m=y.durationInWeeks;if(!X||!m||m<1)return null;try{const g=X+m-1,D=U(z(g)),Z=te(D.mondayOfWeek,6);return{info:D,sunday:Z}}catch(g){return console.error("Could not calculate project end week",g),null}},[X,y.durationInWeeks]),n=async()=>{try{const m={...y,startOn:y.startOn?new Date(y.startOn).toISOString():void 0,durationInWeeks:y.durationInWeeks||1,tags:le};if(s&&s.id)await t.mutateAsync({...m,id:s.id});else{const g=await u.mutateAsync(m),D=g==null?void 0:g.id;D&&r(`/project/${D}`),a&&a()}}catch(m){console.error("Error saving project:",m),J("Failed to save project. Please try again.")}},C=async m=>{if(m.preventDefault(),J(null),!y.name||!y.timeZone||!y.startOn||!y.durationInWeeks){J("Please fill in all required fields");return}if(s&&s.id&&j){const g=y.people||[],D=s.people.some(I=>I.personId===j&&I.canEdit),Z=g.find(I=>I.personId===j),B=(Z==null?void 0:Z.canEdit)||!1;if(D&&!B&&g.filter(I=>I.canEdit).length===0){J("You cannot remove yourself as the only editor. Another editor must be assigned before you can remove yourself, or another editor can remove you.");return}if(D&&!B&&g.filter(I=>I.canEdit).length>0){const I=`Are you sure you want to remove yourself as an editor? You will no longer have edit access to this project${s.status===$.Draft||s.visibility===se.NonDisclosed?", and you may not be able to see it if it remains in draft status or non-disclosed":""}.`;i(I,n);return}}await n()},S=m=>{ee(m)};return e.jsxs(e.Fragment,{children:[e.jsxs(xe,{onSubmit:C,className:"p-4 border rounded bg-light",children:[de&&e.jsx(be,{color:"danger",children:de}),e.jsxs("div",{className:"d-flex justify-content-between align-items-start mb-4",children:[e.jsx("div",{}),e.jsx("div",{children:s&&s.id&&e.jsxs(e.Fragment,{children:[e.jsx(A,{color:"success",outline:!0,className:"me-2",disabled:N.isPending,onClick:()=>{p(s.status===$.Draft?$.Published:$.Draft),v(!0)},children:s.status===$.Draft?"Publish":"Revert to Draft"}),e.jsx(A,{color:"warning",outline:!0,disabled:x.isPending,onClick:()=>{R(s.visibility===se.Disclosed?se.NonDisclosed:se.Disclosed),v(!0)},children:s.visibility===se.Disclosed?"Make Non-Disclosed":"Make Disclosed"})]})})]}),e.jsxs(Y,{className:"mb-3",children:[e.jsx(P,{md:8,children:e.jsxs(O,{children:[e.jsx(F,{for:"name",children:"Name *"}),e.jsx(w,{id:"name",value:y.name||"",onChange:m=>T(g=>({...g,name:m.target.value})),required:!0})]})}),e.jsx(P,{md:4,children:e.jsxs(O,{children:[e.jsx(F,{children:"Engagement Context"}),e.jsxs(w,{type:"select",value:y.engagementContext,onChange:m=>T(g=>({...g,engagementContext:parseInt(m.target.value)})),children:[e.jsx("option",{value:G.BAU,children:"Business As Usual (BAU)"}),e.jsx("option",{value:G.NonBAU,children:"Non-Business As Usual (Non-BAU)"})]}),e.jsxs(ue,{color:"muted",children:[e.jsx("strong",{children:"BAU:"})," Routine operational work or standard business activities.",e.jsx("br",{}),e.jsx("strong",{children:"Non-BAU:"})," Change initiatives, strategic projects, or transformation efforts that are outside normal operations."]})]})})]}),e.jsxs(O,{children:[e.jsx(F,{for:"description",children:"Description"}),e.jsx(w,{id:"description",type:"textarea",value:y.description||"",onChange:m=>T(g=>({...g,description:m.target.value})),rows:3})]}),e.jsx(O,{children:s&&s.id?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx(F,{children:"Timezone"}),s.status===$.Draft&&e.jsx(A,{color:"link",size:"sm",onClick:()=>W(!0),className:"p-0",children:"Change"})]}),e.jsx(w,{value:y.timeZone||"",disabled:!0,className:"mb-3"}),s.status!==$.Draft&&e.jsx("small",{className:"text-muted",children:"Timezone can only be changed when project is in Draft status"})]}):e.jsx(Be,{value:y.timeZone||"",onChange:m=>T(g=>({...g,timeZone:m})),label:"Timezone *",className:"mb-3"})}),e.jsxs(Y,{className:"mb-3",children:[e.jsx(P,{md:8,children:e.jsx(Ge,{value:X,onChange:(m,g)=>{re(m),T(D=>({...D,startOn:g.mondayOfWeek.toISOString().split("T")[0]}))},label:"Start Week *"})}),e.jsx(P,{md:4,children:e.jsxs(O,{children:[e.jsx(F,{for:"durationInWeeks",children:"Duration (Weeks) *"}),e.jsx(w,{type:"number",id:"durationInWeeks",value:y.durationInWeeks||"",onChange:m=>T(g=>({...g,durationInWeeks:parseInt(m.target.value,10)||1})),min:"1",required:!0,bsSize:"sm"}),d&&e.jsxs(ue,{children:["Ends Sun,"," ",d.sunday.toLocaleDateString(),e.jsx("br",{}),e.jsxs("small",{className:"text-muted",children:["(Week ",d.info.weekOfYear," ","of ",d.info.year,")"]})]})]})})]}),e.jsxs(O,{children:[e.jsx(F,{children:"Project People"}),e.jsx(Te,{selectedPersonIds:[],onPersonSelectionChange:m=>{const g=m.map(D=>({personId:D,projectRole:"Team Member",canEdit:!1,canEditResources:!1}));T(D=>({...D,people:[...D.people||[],...g]}))},label:"",placeholder:"Add people to project..."}),y.people&&y.people.length>0&&e.jsxs(Ve,{striped:!0,className:"mt-3",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Role"}),e.jsx("th",{children:"Can Edit"}),e.jsx("th",{children:"Can Edit Resources"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:y.people.map((m,g)=>{var Z;const D=(Z=s==null?void 0:s.people.find(B=>B.personId===m.personId))==null?void 0:Z.person;return e.jsxs("tr",{children:[e.jsx("td",{children:D?`${D.firstName} ${D.lastName}`:m.personId}),e.jsx("td",{children:e.jsx(w,{type:"text",value:m.projectRole,onChange:B=>{const I=[...y.people||[]];I[g].projectRole=B.target.value,T(ae=>({...ae,people:I}))},placeholder:"Enter role...",maxLength:100})}),e.jsx("td",{children:e.jsx(w,{type:"checkbox",checked:m.canEdit,onChange:B=>{const I=[...y.people||[]];I[g].canEdit=B.target.checked,T(ae=>({...ae,people:I}))}})}),e.jsx("td",{children:e.jsx(w,{type:"checkbox",checked:m.canEditResources,onChange:B=>{const I=[...y.people||[]];I[g].canEditResources=B.target.checked,T(ae=>({...ae,people:I}))}})}),e.jsx("td",{children:e.jsx(A,{color:"danger",size:"sm",onClick:()=>{const B=(y.people||[]).filter((I,ae)=>ae!==g);T(I=>({...I,people:B}))},children:"Remove"})})]},m.personId)})})]})]}),e.jsxs(O,{children:[e.jsx(F,{children:"Tags"}),e.jsx(Xe,{selectedTags:le,onChange:S,placeholder:"Select or create tags...",isLoading:l,allowCreate:!0})]}),e.jsxs("div",{className:"d-flex justify-content-end gap-2",children:[e.jsx(A,{color:"secondary",onClick:()=>{!s||!s.id?r("/projects"):o&&o()},children:"Close Edit"}),e.jsx(A,{color:"primary",type:"submit",disabled:u.isPending||t.isPending,children:u.isPending||t.isPending?"Saving...":"Save"})]})]}),e.jsx(ce,{isOpen:k,onClose:()=>v(!1),onSubmit:async m=>{!s||!s.id||(E!==null?(await N.mutateAsync({projectId:s.id,newStatus:E,changeReason:m}),p(null)):b!==null&&(await x.mutateAsync({projectId:s.id,newVisibility:b,changeReason:m}),R(null)),v(!1))},description:E?E===$.Published?"publish this project":"revert this project to Draft":b!==null?b===se.Disclosed?"make this project Disclosed":"make this project Non-Disclosed":"",isPending:N.isPending||x.isPending,projectStatus:s==null?void 0:s.status}),s&&s.id&&e.jsx(js,{isOpen:h,onClose:()=>W(!1),projectId:s.id,currentTimeZone:y.timeZone||"",projectStatus:s.status}),c]})};function bs(s){return s.trim().replace(/([a-z])([A-Z])/g,"$1-$2").replace(/\W|_/g,a=>/[À-ž]/.test(a)?a:"-").replace(/^-+|-+$/g,"").replace(/-{2,}/g,"-").toLowerCase()}const Ns=s=>s.charAt(0).toUpperCase()+s.slice(1);function ys(s){return Ns(bs(s).replace(/-/g," "))}const pe=["#4F46E5","#7C3AED","#DB2777","#DC2626","#EA580C","#16A34A","#0891B2","#8B5CF6","#F59E0B","#10B981","#3B82F6","#EF4444"],ks=s=>s<0?pe[0]:pe[s%pe.length],vs=s=>ks(s.length),L=({path:s,error:a,className:o=""})=>{if(!a)return null;let r=null;if(a instanceof Le)r=a.problemDetails;else if(Ye(a))r=a;else return null;if(!r.errors)return null;if(Array.isArray(r.errors)){const j=r.errors.find(k=>k.key===s);return j?e.jsx("div",{className:`text-danger small mt-1 ${o}`,children:j.message}):null}const c=r.errors[s];if(c){const j=Array.isArray(c)?c.join(", "):String(c);return e.jsx("div",{className:`text-danger small mt-1 ${o}`,children:j})}return null},Cs=()=>{const s=K(),a=ne();return V({mutationFn:async o=>{const r=await s(`${_}/api/projects/phases/bulk-update`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});return H(r)},onSuccess:(o,r)=>{a.invalidateQueries({queryKey:["projects",r.projectId]})}})},Ss=()=>{const s=K(),a=ne();return V({mutationFn:async({phaseId:o,projectId:r,changeReason:i})=>{const c=await s(`${_}/api/projects/phases/${o}`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({changeReason:i})});return H(c)},onSuccess:(o,r)=>{a.invalidateQueries({queryKey:["projects",r.projectId]})}})},Ws=({project:s,canCurrentUserEdit:a})=>{const[o,r]=f.useState(new Set),[i,c]=f.useState([]),[j,k]=f.useState(!1),[v,h]=f.useState([]),[W,E]=f.useState(!1),[p,N]=f.useState(null),x=Cs(),b=Ss();f.useEffect(()=>{const t=s.phases.map((d,n)=>({...d,isNew:!1,isEditing:!1,hasChanges:!1,originalData:{...d},index:n}));c(t)},[s.phases]);const R=t=>{r(d=>{const n=new Set(d);return n.has(t)?n.delete(t):n.add(t),n})},M=()=>{const t=s.startGlobalWeekNumber,d=z(t),n=t,C=z(n),S=te(C,6),m={id:`temp-${Date.now()}`,projectId:s.id,name:"",description:"",startGlobalWeekNumber:t,startOn:d.toISOString(),endGlobalWeekNumber:n,endOn:S.toISOString(),durationInWeeks:1,type:me.Delivery,colour:vs(i),isNew:!0,isEditing:!0,hasChanges:!0,originalData:{},index:i.length};c(g=>[...g,m])},ie=t=>{c(d=>d.map(n=>n.id===t?n.isEditing?n.isNew?null:{...n.originalData,isEditing:!1,hasChanges:!1,originalData:n.originalData}:{...n,isEditing:!0,originalData:{...n}}:n).filter(Boolean))},q=(t,d,n)=>{c(C=>C.map(S=>S.id===t?{...S,[d]:n,hasChanges:!0}:S))},y=(t,d,n)=>{const C=Math.max(d,s.startGlobalWeekNumber),S=z(C),m=C+n-1,g=z(m),D=te(g,6);c(Z=>Z.map(B=>B.id===t?{...B,startGlobalWeekNumber:C,startOn:S.toISOString(),endGlobalWeekNumber:m,endOn:D.toISOString(),durationInWeeks:n,hasChanges:!0}:B))},T=t=>{try{const d=U(z(t.startGlobalWeekNumber)),n=U(z(t.endGlobalWeekNumber));return{startWeekInfo:d,endWeekInfo:n}}catch(d){return console.error("Error getting phase week info:",d),null}},X=()=>{const t=i.filter(d=>d.endGlobalWeekNumber).map(d=>d.endGlobalWeekNumber);return t.length===0?null:Math.max(...t)},re=t=>{if(t.isNew)return{name:t.name,description:t.description,startGlobalWeekNumber:t.startGlobalWeekNumber,durationInWeeks:t.durationInWeeks,type:t.type,colour:t.colour,index:t.index};const d={id:t.id,index:t.index},n=t.originalData;return t.name!==n.name&&(d.name=t.name),t.description!==n.description&&(d.description=t.description),t.startGlobalWeekNumber!==n.startGlobalWeekNumber&&(d.startGlobalWeekNumber=t.startGlobalWeekNumber),t.durationInWeeks!==n.durationInWeeks&&(d.durationInWeeks=t.durationInWeeks),t.type!==n.type&&(d.type=t.type),t.colour!==n.colour&&(d.colour=t.colour),d},le=()=>{const t=i.filter(n=>n.isEditing&&n.hasChanges);if(t.length===0)return;const d=t.map(re);h(d),k(!0)},ee=async t=>{v.length!==0&&x.mutate({projectId:s.id,phases:v,changeReason:t},{onSuccess:()=>{c(d=>d.map(n=>({...n,isEditing:!1,hasChanges:!1,originalData:{...n}}))),h([]),k(!1)}})},de=t=>{N(t),E(!0)},J=async t=>{p&&b.mutate({phaseId:p,projectId:s.id,changeReason:t},{onSuccess:()=>{E(!1),N(null)}})},l=i.some(t=>t.isEditing&&t.hasChanges),u=[{value:me.Delivery,label:"Delivery"},{value:me.Delivered,label:"Delivered"}];return e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsx("h3",{children:"Phases"}),e.jsxs("div",{children:[l&&e.jsxs(A,{color:"success",size:"sm",onClick:le,disabled:x.isPending,className:"me-2",children:[e.jsx($e,{size:14,className:"me-1"}),"Update Phases"]}),a&&e.jsxs(A,{color:"primary",outline:!0,size:"sm",onClick:M,className:"me-2",children:[e.jsx(Me,{size:14,className:"me-1"}),"Add Phase"]})]})]}),e.jsx(oe,{error:x.error,title:"Failed to update phases",onDismiss:()=>x.reset(),className:"mb-3"}),b.error&&e.jsx(oe,{error:b.error,title:"Failed to delete phase",onDismiss:()=>b.reset(),className:"mb-3"}),(()=>{const t=X(),d=s.endGlobalWeekNumber;if(t&&t>d)try{const C=U(z(d)),S=U(z(t));return e.jsx("div",{className:"alert alert-warning mb-3",role:"alert",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("i",{className:"fas fa-exclamation-triangle me-2"}),e.jsxs("div",{children:[e.jsx("strong",{children:"Project End Week Extension Required"}),e.jsxs("div",{className:"small mt-1",children:["One or more phases extend beyond the current project end week (Week"," ",C.weekOfYear," of"," ",C.year,"). The project will be automatically extended to Week"," ",S.weekOfYear," of"," ",S.year," when these changes are saved."]})]})]})})}catch{return e.jsx("div",{className:"alert alert-warning mb-3",role:"alert",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("i",{className:"fas fa-exclamation-triangle me-2"}),e.jsxs("div",{children:[e.jsx("strong",{children:"Project Extension Required"}),e.jsx("div",{className:"small mt-1",children:"One or more phases extend beyond the current project duration."})]})]})})}return null})(),i.length===0?e.jsx("p",{className:"text-muted",children:"No phases defined yet"}):e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:{width:"40px"}}),e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Colour"}),e.jsx("th",{children:"Start Week"}),e.jsx("th",{children:"Duration (Weeks)"}),a&&e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:i.map(t=>{const d=o.has(t.id);return e.jsxs(We.Fragment,{children:[e.jsxs("tr",{className:t.isEditing?"phase-editing-row":"",style:{borderLeft:t.colour?`5px solid ${t.colour}`:void 0},children:[e.jsx("td",{children:!t.isNew&&e.jsx(A,{color:"link",size:"sm",className:"p-0 text-muted",onClick:()=>R(t.id),title:d?"Hide description":"Show description",children:d?e.jsx(Ee,{size:14}):e.jsx(Ie,{size:14})})}),e.jsx("td",{children:t.isEditing?e.jsxs("div",{children:[e.jsx(w,{value:t.name,onChange:n=>q(t.id,"name",n.target.value),placeholder:"Phase name",bsSize:"sm"}),e.jsx(L,{path:`phases.${t.index}.name`,error:x.error})]}):t.name}),e.jsx("td",{children:t.isEditing?e.jsxs("div",{children:[e.jsx(es,{value:u.find(n=>n.value===t.type),onChange:n=>q(t.id,"type",n==null?void 0:n.value),options:u,classNamePrefix:"react-select",className:"react-select-sm"}),e.jsx(L,{path:`phases.${t.index}.type`,error:x.error})]}):me[t.type]}),e.jsx("td",{children:t.isEditing?e.jsx(w,{type:"color",value:t.colour||"#FFFFFF",onChange:n=>q(t.id,"colour",n.target.value),className:"form-control-sm",style:{width:"50px",height:"31px",padding:"0.1rem 0.2rem"}}):e.jsx("div",{style:{width:"20px",height:"20px",backgroundColor:t.colour||"transparent",border:"1px solid #ccc",borderRadius:"3px"}})}),e.jsx("td",{children:t.isEditing?e.jsxs("div",{children:[e.jsx(Ge,{value:t.startGlobalWeekNumber,onChange:n=>{y(t.id,n,t.durationInWeeks)},label:"",className:"mb-0"}),e.jsx(L,{path:`phases.${t.index}.startGlobalWeekNumber`,error:x.error})]}):(()=>{const n=T(t);return n?e.jsxs("div",{children:[e.jsxs("div",{children:["Week"," ",n.startWeekInfo.weekOfYear," ","of"," ",n.startWeekInfo.year]}),e.jsx("small",{className:"text-muted",children:Q(n.startWeekInfo.mondayOfWeek)})]}):Q(t.startOn)})()}),e.jsx("td",{children:t.isEditing?e.jsxs("div",{children:[e.jsx(w,{type:"number",value:t.durationInWeeks||"",onChange:n=>{const C=parseInt(n.target.value,10)||1;y(t.id,t.startGlobalWeekNumber,C)},min:"1",max:s.durationInWeeks,bsSize:"sm",style:{width:"80px"}}),e.jsx(L,{path:`phases.${t.index}.durationInWeeks`,error:x.error}),(()=>{const n=T(t);return n?e.jsxs(ue,{children:["Ends Week"," ",n.endWeekInfo.weekOfYear," ","of"," ",n.endWeekInfo.year,e.jsx("br",{}),e.jsxs("small",{className:"text-muted",children:["(Sun,"," ",Q(te(n.endWeekInfo.mondayOfWeek,6)),")"]})]}):null})()]}):e.jsxs("div",{children:[e.jsxs("div",{children:[t.durationInWeeks," ","week",t.durationInWeeks!==1?"s":""]}),e.jsxs("small",{className:"text-muted",children:["Ends"," ",Q(t.endOn)]})]})}),a&&e.jsx("td",{className:"phase-actions",children:e.jsx("div",{className:"btn-group-inline",children:e.jsx(A,{color:"link",size:"sm",className:"p-0",onClick:()=>ie(t.id),title:t.isEditing?"Cancel editing":"Edit phase",children:t.isEditing?e.jsx(De,{size:14}):e.jsx(Pe,{size:14})})})})]}),d&&!t.isNew&&e.jsxs("tr",{children:[e.jsx("td",{colSpan:6,className:"p-0",children:(t.isEditing||t.description)&&e.jsxs("div",{className:"p-3 bg-light border-bottom",children:[e.jsx("small",{className:"text-muted d-block mb-1",children:"Description:"}),t.isEditing?e.jsx(O,{className:"mb-0",children:e.jsx(w,{type:"textarea",value:t.description||"",onChange:n=>q(t.id,"description",n.target.value),placeholder:"Phase description",rows:3,bsSize:"sm"})}):e.jsx("div",{children:t.description})]})}),a&&e.jsx("td",{children:t.isEditing&&!t.isNew&&e.jsx("div",{className:"d-flex justify-content-start",children:e.jsx(A,{color:"link",size:"sm",className:"p-0 text-danger me-2",onClick:()=>de(t.id),disabled:b.isPending,title:"Delete phase",children:e.jsx(ye,{size:14})})})})]})]},t.id)})})]}),e.jsx(ce,{isOpen:j,onClose:()=>{k(!1),h([])},onSubmit:ee,description:`update ${v.length} phase${v.length>1?"s":""}`,isPending:x.isPending,projectStatus:s==null?void 0:s.status}),e.jsx(ce,{isOpen:W,onClose:()=>{E(!1),N(null)},onSubmit:J,description:"delete this phase",isPending:b.isPending,projectStatus:s==null?void 0:s.status})]})},qe=({weekInfo:s,globalWeekNumber:a})=>{const o=s||(a?U(z(a)):null);return o?e.jsxs(e.Fragment,{children:[e.jsxs("span",{className:"fw-medium",children:["Week ",o.weekOfYear," of ",o.year]}),e.jsxs("small",{className:"text-muted ms-2",children:["(",Q(o.mondayOfWeek)," -"," ",Q(te(o.mondayOfWeek,6)),")"]})]}):null},Es=(s,a)=>{const o=`${_}/api/projects/${s}/allocations`,r=["project-allocations",s],i=K();return Qe({queryKey:r,queryFn:async()=>{const c=await i(o);return H(c)},enabled:!!s,...a})},Is=s=>{const a=K();return V({mutationFn:async({allocationId:o,changeReason:r})=>{const i=await a(`${_}/api/allocations/${o}`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({changeReason:r})});return H(i)},...s})},Ds=()=>{const s=K(),a=ne();return V({mutationFn:async o=>{const r=await s(`${_}/api/projects/${o.projectId}/allocations/bulk-update`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});return H(r)},onSuccess:(o,r)=>{a.invalidateQueries({queryKey:["project-allocations",r.projectId]}),a.invalidateQueries({queryKey:["project-allocations"]})}})},Ps=({allocation:s,project:a,teamsData:o,bulkUpdateAllocation:r,onUpdateField:i,onDelete:c,deleteAllocation:j})=>{var v;const k=((v=o==null?void 0:o.items)==null?void 0:v.map(h=>({value:h.id,label:h.name})))||[];return e.jsxs(xe,{className:"p-3 bg-light border-top",children:[e.jsxs(Y,{children:[e.jsxs(P,{md:6,children:[e.jsxs(O,{children:[e.jsx(F,{children:"Assignment Type"}),e.jsxs(w,{type:"select",value:s.assignmentType,onChange:h=>{const W=h.target.value;i(s.globalWeekNumber,s.id,"assignmentType",W),W==="person"?i(s.globalWeekNumber,s.id,"teamId",void 0):i(s.globalWeekNumber,s.id,"personId",void 0)},disabled:!s.isNew,children:[e.jsx("option",{value:"person",children:"Person"}),e.jsx("option",{value:"team",children:"Team"})]}),e.jsx(L,{path:`allocations.${s.index}.resource`,error:r.error}),!s.isNew&&e.jsx("small",{className:"text-muted mt-1 d-block",children:"Assignment type cannot be changed for existing records. Delete this allocation and create a new one to change the assignment type."})]}),s.assignmentType==="person"?e.jsxs(e.Fragment,{children:[e.jsx(Te,{selectedPersonIds:s.personId?[s.personId]:[],onPersonSelectionChange:h=>{i(s.globalWeekNumber,s.id,"personId",h[0]||void 0)},label:"Person",placeholder:"Select a person",disabled:!s.isNew}),!s.isNew&&e.jsx("small",{className:"text-muted mt-1 d-block",children:"Person cannot be changed for existing records. Delete this allocation and create a new one to change the person."})]}):e.jsxs(O,{children:[e.jsx(F,{children:"Team"}),e.jsxs(w,{type:"select",value:s.teamId||"",onChange:h=>i(s.globalWeekNumber,s.id,"teamId",h.target.value||void 0),disabled:!s.isNew,children:[e.jsx("option",{value:"",children:"Select a team"}),k.map(h=>e.jsx("option",{value:h.value,children:h.label},h.value))]}),e.jsx(L,{path:`allocations.${s.index}.teamId`,error:r.error}),!s.isNew&&e.jsx("small",{className:"text-muted mt-1 d-block",children:"Team cannot be changed for existing records. Delete this allocation and create a new one to change the team."})]})]}),e.jsxs(P,{md:6,children:[e.jsxs(Y,{children:[e.jsx(P,{md:6,children:e.jsxs(O,{children:[e.jsx(F,{children:"Week"}),e.jsx("div",{className:"form-control-plaintext",children:e.jsx(qe,{globalWeekNumber:s.globalWeekNumber})}),e.jsx(L,{path:`allocations.${s.index}.globalWeekNumber`,error:r.error})]})}),e.jsx(P,{md:6})]}),e.jsxs(Y,{children:[e.jsx(P,{md:6,children:e.jsxs(O,{children:[e.jsx(F,{children:"Business As Usual Hours"}),e.jsx(w,{type:"number",value:s.hoursBAU,onChange:h=>i(s.globalWeekNumber,s.id,"hoursBAU",parseFloat(h.target.value)||0),min:"0",step:"0.25"}),e.jsx("small",{className:"text-muted",children:"Regular operational work and ongoing activities"}),e.jsx(L,{path:`allocations.${s.index}.hoursBAU`,error:r.error})]})}),(a.engagementContext!==G.BAU||s.hoursNonBAU&&s.hoursNonBAU>0)&&e.jsx(P,{md:6,children:e.jsxs(O,{children:[e.jsx(F,{children:"Non-Business As Usual Hours"}),e.jsx(w,{type:"number",value:s.hoursNonBAU,onChange:h=>i(s.globalWeekNumber,s.id,"hoursNonBAU",parseFloat(h.target.value)||0),min:"0",step:"0.5"}),e.jsx("small",{className:"text-muted",children:"Project work, initiatives, and special activities"}),e.jsx(L,{path:`allocations.${s.index}.hoursNonBAU`,error:r.error})]})})]}),e.jsxs(Y,{children:[e.jsx(P,{md:6,children:e.jsxs(O,{children:[e.jsx(F,{children:"Allocation Type"}),e.jsxs(w,{type:"select",value:s.allocationType,onChange:h=>i(s.globalWeekNumber,s.id,"allocationType",parseInt(h.target.value)),children:[e.jsx("option",{value:he.Delivery,children:"Delivery"}),e.jsx("option",{value:he.DeliveredTo,children:"Delivered To"})]})]})}),e.jsx(P,{md:6})]})]})]}),e.jsx(Y,{className:"mt-3",children:e.jsx(P,{md:12,children:e.jsxs(O,{children:[e.jsx(F,{children:"Description"}),e.jsx(w,{type:"textarea",value:s.description,onChange:h=>i(s.globalWeekNumber,s.id,"description",h.target.value),rows:3}),e.jsx(L,{path:`allocations.${s.index}.description`,error:r.error})]})})}),s.isEditing&&!s.isNew&&e.jsx("div",{className:"mt-3 d-flex justify-content-start",children:e.jsxs(A,{color:"link",size:"sm",className:"p-1 text-danger",onClick:()=>c(s.id),disabled:j.isPending,title:"Delete allocation",children:[e.jsx(ye,{size:12,className:"me-1"}),"Delete"]})})]})},ws=({project:s,canCurrentUserEdit:a})=>{const[o,r]=f.useState([]),[i,c]=f.useState(!1),[j,k]=f.useState([]),[v,h]=f.useState(!1),[W,E]=f.useState(null),{data:p,isLoading:N,error:x}=Es(s.id),{data:b}=ds(1,100),R=Ds(),M=Is();f.useEffect(()=>{if(!s.startGlobalWeekNumber||!s.durationInWeeks)return;const l=[];for(let u=0;u<s.durationInWeeks;u++){const t=s.startGlobalWeekNumber+u,d=U(z(t)),C=((p==null?void 0:p.filter(S=>S.globalWeekNumber===t))||[]).map((S,m)=>({...S,isNew:!1,isEditing:!1,hasChanges:!1,originalData:{...S},index:m,assignmentType:S.personId?"person":"team"}));l.push({globalWeekNumber:t,weekInfo:d,allocations:C,isExpanded:!1,isEditing:!1})}r(l)},[s.startGlobalWeekNumber,s.durationInWeeks,p]);const ie=l=>{r(u=>u.map(t=>t.globalWeekNumber===l?{...t,isExpanded:!t.isExpanded}:t))},q=l=>{const u=U(z(l)),t=u.mondayOfWeek.toISOString(),d=te(u.mondayOfWeek,6).toISOString(),n=s.engagementContext===G.BAU?8:0,C=s.engagementContext===G.BAU?0:8,S={id:`temp-${Date.now()}`,projectId:s.id,personId:void 0,teamId:void 0,person:void 0,team:void 0,description:"",globalWeekNumber:l,weekBeginningOn:t,weekEndOn:d,hoursBAU:n,hoursNonBAU:C,allocationType:he.Delivery,createdAt:new Date().toISOString(),updatedAt:void 0,isNew:!0,isEditing:!0,hasChanges:!0,originalData:{},index:0,assignmentType:"person"};r(m=>m.map(g=>g.globalWeekNumber===l?{...g,allocations:[...g.allocations,S],isExpanded:!0,isEditing:!0}:g))},y=(l,u)=>{r(t=>t.map(d=>d.globalWeekNumber===l?{...d,allocations:d.allocations.map(n=>n.id===u?n.isEditing?n.isNew?null:{...n.originalData,isEditing:!1,hasChanges:!1,originalData:n.originalData}:{...n,isEditing:!0,originalData:{...n}}:n).filter(Boolean),isEditing:d.allocations.some(n=>n.isEditing&&n.hasChanges)}:d))},T=(l,u,t,d)=>{r(n=>n.map(C=>C.globalWeekNumber===l?{...C,allocations:C.allocations.map(S=>S.id===u?{...S,[t]:d,hasChanges:!0}:S),isEditing:!0}:C))},X=l=>{if(l.isNew)return{personId:l.personId,teamId:l.teamId,description:l.description,globalWeekNumber:l.globalWeekNumber,hoursBAU:l.hoursBAU,hoursNonBAU:l.hoursNonBAU,allocationType:l.allocationType,index:l.index};const u={id:l.id,index:l.index},t=l.originalData;return l.personId!==t.personId&&(u.personId=l.personId),l.teamId!==t.teamId&&(u.teamId=l.teamId),l.description!==t.description&&(u.description=l.description),l.hoursBAU!==t.hoursBAU&&(u.hoursBAU=l.hoursBAU),l.hoursNonBAU!==t.hoursNonBAU&&(u.hoursNonBAU=l.hoursNonBAU),l.allocationType!==t.allocationType&&(u.allocationType=l.allocationType),u},re=()=>{const l=o.flatMap(t=>t.allocations).filter(t=>t.isEditing&&t.hasChanges);if(l.length===0)return;const u=l.map(X);k(u),c(!0)},le=async l=>{if(j.length===0)return;const u={projectId:s.id,allocations:j,changeReason:l};R.mutate(u,{onSuccess:()=>{r(t=>t.map(d=>({...d,allocations:d.allocations.map(n=>({...n,isEditing:!1,hasChanges:!1,originalData:{...n}})),isEditing:!1}))),k([]),c(!1)}})},ee=l=>{E(l),h(!0)},de=async l=>{W&&M.mutate({allocationId:W,changeReason:l},{onSuccess:()=>{h(!1),E(null)}})},J=o.some(l=>l.isEditing);return N?e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{children:"Resource Allocations"}),e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx(we,{size:"sm",className:"me-2"}),e.jsx("span",{className:"text-muted",children:"Loading allocations..."})]})]}):e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsx("h3",{children:"Resource Allocations"}),e.jsx("div",{children:J&&e.jsxs(A,{color:"success",size:"sm",onClick:re,disabled:R.isPending,className:"me-2",children:[e.jsx($e,{size:14,className:"me-1"}),"Update Allocations"]})})]}),e.jsx(oe,{error:R.error,title:"Failed to update allocations",onDismiss:()=>R.reset(),className:"mb-3"}),e.jsx(oe,{error:x,title:"Failed to load allocations",className:"mb-3"}),M.error&&e.jsx(oe,{error:M.error,title:"Failed to delete allocation",onDismiss:()=>M.reset(),className:"mb-3"}),o.length===0?e.jsx("p",{className:"text-muted",children:"No weeks available for allocation"}):e.jsx("div",{className:"border rounded",children:o.map(l=>e.jsxs("div",{className:"border-bottom",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center p-3 bg-light cursor-pointer",onClick:()=>ie(l.globalWeekNumber),style:{cursor:"pointer"},children:[e.jsxs("div",{className:"d-flex align-items-center",children:[l.isExpanded?e.jsx(Ee,{size:16,className:"me-2"}):e.jsx(Ie,{size:16,className:"me-2"}),e.jsx(fe,{size:16,className:"me-2 text-muted"}),e.jsx("div",{children:e.jsx(qe,{weekInfo:l.weekInfo})})]}),e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsxs("span",{className:"badge bg-secondary me-2",children:[l.allocations.length," allocation",l.allocations.length!==1?"s":""]}),a&&e.jsxs(A,{color:"primary",outline:!0,size:"sm",onClick:u=>{u.stopPropagation(),q(l.globalWeekNumber)},children:[e.jsx(Me,{size:14,className:"me-1"}),"Add Resource"]})]})]}),l.isExpanded&&e.jsx("div",{className:"p-3",children:l.allocations.length===0?e.jsx(be,{color:"info",className:"mb-0",children:e.jsx("small",{children:"No resource allocations for this week"})}):e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-sm mb-0",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Resource"}),e.jsx("th",{children:"Description"}),e.jsx("th",{children:"Hours"}),e.jsx("th",{children:"Type"}),a&&e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:l.allocations.map(u=>e.jsxs(We.Fragment,{children:[e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("div",{className:"d-flex align-items-center",children:u.person?e.jsxs(e.Fragment,{children:[e.jsx(Ae,{size:12,className:"me-1 text-primary"}),e.jsxs("span",{children:[u.person.firstName," ",u.person.lastName]})]}):u.team?e.jsxs(e.Fragment,{children:[e.jsx(Oe,{size:12,className:"me-1 text-info"}),e.jsx("span",{children:u.team.name})]}):e.jsx("span",{className:"text-muted",children:"No resource assigned"})})}),e.jsx("td",{children:u.description||e.jsx("span",{className:"text-muted",children:"No description"})}),e.jsx("td",{children:e.jsxs("div",{children:[e.jsxs("div",{children:[(u.hoursBAU+u.hoursNonBAU).toFixed(1),"h"]}),u.hoursBAU>0&&u.hoursNonBAU>0&&e.jsxs("div",{className:"small text-muted",children:[u.hoursBAU,"h BAU +"," ",u.hoursNonBAU,"h NonBAU"]})]})}),e.jsx("td",{children:e.jsx("div",{children:e.jsx("div",{className:"small",children:he[u.allocationType]})})}),a&&e.jsx("td",{children:e.jsxs("div",{className:"btn-group-inline",children:[e.jsx(A,{color:"link",size:"sm",className:"p-0 me-2",onClick:()=>y(l.globalWeekNumber,u.id),title:u.isEditing?"Cancel editing":"Edit allocation",children:u.isEditing?e.jsx(De,{size:14}):e.jsx(Pe,{size:14})}),!u.isNew&&e.jsx(A,{color:"link",size:"sm",className:"p-0 text-danger",onClick:()=>ee(u.id),disabled:M.isPending,title:"Delete allocation",children:e.jsx(ye,{size:14})})]})})]}),u.isEditing&&e.jsx("tr",{children:e.jsx("td",{colSpan:a?6:5,className:"p-0",children:e.jsx(Ps,{allocation:u,project:s,teamsData:b,bulkUpdateAllocation:R,onUpdateField:T,onDelete:ee,deleteAllocation:M})})})]},u.id))})]})})})]},l.globalWeekNumber))}),e.jsx(ce,{isOpen:i,onClose:()=>{c(!1),k([])},onSubmit:le,description:`update ${j.length} allocation${j.length>1?"s":""}`,isPending:R.isPending,projectStatus:s==null?void 0:s.status}),e.jsx(ce,{isOpen:v,onClose:()=>{h(!1),E(null)},onSubmit:de,description:"delete this allocation",isPending:M.isPending,projectStatus:s==null?void 0:s.status})]})},As=({project:s,onEdit:a})=>{const{personId:o}=Ne(),r=o&&s.people.some(i=>i.personId===o&&i.canEdit);return e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-start mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{children:s.name}),s.description&&e.jsx("p",{className:"text-muted mb-0",children:s.description})]}),e.jsx("div",{children:r&&e.jsx(A,{color:"primary",outline:!0,onClick:()=>a(s),className:"me-2",children:"Edit"})})]}),s.tags&&s.tags.length>0&&e.jsx("div",{className:"mb-4",children:e.jsx("div",{className:"d-flex flex-wrap gap-2",children:s.tags.map(i=>e.jsx(rs,{tag:i},i.id||i.name))})}),e.jsxs(Y,{className:"mb-4",children:[e.jsx(P,{md:3,children:e.jsxs("div",{className:"d-flex align-items-center mb-2",children:[e.jsx(Ce,{size:16,className:"text-muted me-2"}),e.jsxs("div",{children:[e.jsx("small",{className:"text-muted d-block",children:"Status"}),e.jsx("span",{className:"fw-medium",children:$[s.status]})]})]})}),e.jsx(P,{md:3,children:e.jsxs("div",{className:"d-flex align-items-center mb-2",children:[e.jsx(fe,{size:16,className:"text-muted me-2"}),e.jsxs("div",{children:[e.jsx("small",{className:"text-muted d-block",children:"Start"}),e.jsx("span",{className:"fw-medium",children:Q(s.startOn)})]})]})}),e.jsx(P,{md:3,children:e.jsxs("div",{className:"d-flex align-items-center mb-2",children:[e.jsx(fe,{size:16,className:"text-muted me-2"}),e.jsxs("div",{children:[e.jsx("small",{className:"text-muted d-block",children:"End"}),e.jsx("span",{className:"fw-medium",children:Q(new Date(new Date(s.startOn).getTime()+(s.durationInWeeks*7-1)*24*60*60*1e3).toISOString())})]})]})}),e.jsx(P,{md:3,children:e.jsxs("div",{className:"d-flex align-items-center mb-2",children:[e.jsx(as,{size:16,className:"text-muted me-2"}),e.jsxs("div",{children:[e.jsx("small",{className:"text-muted d-block",children:"Timezone"}),e.jsx("span",{className:"fw-medium",children:s.timeZone||"Not set"})]})]})})]}),e.jsxs(Y,{className:"mb-4",children:[e.jsx(P,{md:3,children:e.jsxs("div",{className:"d-flex align-items-center mb-2",children:[e.jsx(cs,{size:16,className:"text-muted me-2"}),e.jsxs("div",{children:[e.jsx("small",{className:"text-muted d-block",children:"Visibility"}),e.jsx("span",{className:"fw-medium",children:ys(se[s.visibility])})]})]})}),e.jsx(P,{md:3,children:e.jsxs("div",{className:"d-flex align-items-center mb-2",children:[e.jsx(ms,{size:16,className:"text-muted me-2"}),e.jsxs("div",{children:[e.jsx("small",{className:"text-muted d-block",children:"Duration"}),e.jsxs("span",{className:"fw-medium",children:[s.durationInWeeks," week",s.durationInWeeks!==1?"s":""]})]})]})}),e.jsx(P,{md:3,children:e.jsxs("div",{className:"d-flex align-items-center mb-2",children:[e.jsx(Ce,{size:16,className:"text-muted me-2"}),e.jsxs("div",{children:[e.jsx("small",{className:"text-muted d-block",children:"Engagement Context"}),e.jsx("span",{className:"fw-medium",children:s.engagementContext===G.BAU?"Business As Usual":"Non-Business As Usual"}),e.jsx("div",{className:"small text-muted mt-1",children:s.engagementContext===G.BAU?"Routine operational work or standard business activities":"Change initiatives, strategic projects, or transformation efforts that are outside normal operations"})]})]})})]}),s.people.length>0&&e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"d-flex align-items-center mb-3",children:[e.jsx(Oe,{size:20,className:"text-muted me-2"}),e.jsx("h3",{className:"mb-0",children:"People"}),e.jsx("span",{className:"badge bg-secondary ms-2",children:s.people.length})]}),e.jsx(Y,{children:s.people.map(i=>e.jsx(P,{md:6,lg:4,className:"mb-3",children:e.jsx("div",{className:"border rounded p-3 h-100",children:e.jsxs("div",{className:"d-flex align-items-start",children:[e.jsx("div",{className:"bg-light rounded-circle p-2 me-3 flex-shrink-0",children:e.jsx(Ae,{size:16,className:"text-muted"})}),e.jsxs("div",{className:"flex-grow-1 min-width-0",children:[e.jsx("div",{className:"fw-medium text-truncate",children:`${i.person.firstName} ${i.person.lastName}`}),e.jsxs("div",{className:"small text-muted mb-1",children:[i.projectRole,i.canEdit&&" (Editor)"]}),e.jsxs("div",{className:"d-flex align-items-center small text-muted",children:[e.jsx(os,{size:12,className:"me-1 flex-shrink-0"}),e.jsx("a",{href:`mailto:${i.person.email}`,className:"text-truncate text-primary",style:{cursor:"pointer",textDecoration:"none",transition:"all 0.2s ease"},onMouseEnter:c=>{const j=c.target;j.style.textDecoration="underline"},onMouseLeave:c=>{const j=c.target;j.style.textDecoration="none"},title:`Send email to ${i.person.email}`,children:i.person.email})]}),i.person.phoneNumber&&e.jsxs("div",{className:"d-flex align-items-center small text-muted",children:[e.jsx(ls,{size:12,className:"me-1 flex-shrink-0"}),e.jsx("a",{href:`tel:${i.person.phoneNumber}`,className:"text-truncate text-primary",style:{cursor:"pointer",textDecoration:"none",transition:"all 0.2s ease"},onMouseEnter:c=>{const j=c.target;j.style.textDecoration="underline"},onMouseLeave:c=>{const j=c.target;j.style.textDecoration="none"},title:`Call ${i.person.phoneNumber}`,children:i.person.phoneNumber})]})]})]})})},i.id))})]}),e.jsx(Ws,{project:s,canCurrentUserEdit:!!r}),e.jsx(ws,{project:s,canCurrentUserEdit:!!r})]})},Os=(s,a)=>{const{mondayOfWeek:o,globalWeekNumber:r}=U(new Date),i=o.toISOString().split("T")[0],c=new Date(o);return c.setDate(c.getDate()+6),{id:null,name:"",description:"",timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone,startOn:i,durationInWeeks:1,startGlobalWeekNumber:r,endGlobalWeekNumber:r,endOn:c.toISOString(),status:$.Draft,visibility:se.NonDisclosed,engagementContext:G.BAU,customerId:s??je,phases:[],people:a?[{id:"temp-owner",projectId:"",personId:a,projectRole:"Project Owner",canEdit:!0,canEditResources:!0,person:{id:a,firstName:"",lastName:"",email:"",phoneNumber:null}}]:[],tags:[]}},Ts=({projectId:s})=>{const{customerId:a,personId:o}=Ne(),r=s==="_"?je:s,[i,c]=f.useState(!1),{data:j,isLoading:k,error:v}=Je(r),h=r===je,W=f.useMemo(()=>h?Os(a,o):void 0,[h,a,o]),E=()=>{c(!0)},p=()=>{c(!1)},N=()=>{c(!1)},x=h||i,b=h?W:j;return e.jsx(e.Fragment,{children:k&&!h?e.jsxs("div",{className:"text-center p-4",children:[e.jsx(we,{size:"sm"})," Loading details..."]}):v?e.jsx(oe,{error:v}):b?x?e.jsx(fs,{project:b,onSave:p,onCancel:N}):e.jsx(As,{project:b,onEdit:E}):e.jsx("div",{className:"text-center text-muted p-5",children:"Select a project from the left to view details"})})},wt=()=>{const{projectId:s=null}=Ke(),a=Se(),o=()=>e.jsx(Ts,{projectId:s}),r=()=>{const i=[{text:"Projects",onClick:()=>a("/projects")}];return s&&s!=="_"?i.push({text:"Project"}):s==="_"&&i.push({text:"New Project"}),i};return e.jsxs("div",{className:"p-4",children:[e.jsx("div",{className:"mb-3",children:e.jsx(_e,{className:"bg-light p-2 rounded",children:r().map((i,c)=>e.jsx(He,{active:!i.onClick,style:i.onClick?{cursor:"pointer"}:void 0,onClick:i.onClick,children:i.text},c))})}),o()]})};export{wt as default};
//# sourceMappingURL=ProjectPage-Dj1c5cDF.js.map
